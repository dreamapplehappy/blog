# åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„ç¼–è¯‘å™¨ï¼šåœ¨JavaScriptä¸­ä½¿ç”¨Swiftçš„å°¾é—­åŒ…è¯­æ³•

![cover](./images/cover.png)

é¦–å…ˆè·Ÿå¤§å®¶è¯´ä¸€ä¸‹æˆ‘ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªæƒ³æ³•å§ï¼Œå› ä¸ºæœ€è¿‘åœ¨ç©ºé—²æ—¶é—´å­¦ä¹ `Swift`å’Œ`SwiftUI`çš„æ—¶å€™ä¼šç»å¸¸ä½¿ç”¨åˆ°è¿™ç§å«åš[`å°¾é—­åŒ…`](https://docs.swift.org/swift-book/LanguageGuide/Closures.html)çš„è¯­æ³•ï¼Œå°±è§‰å¾—å¾ˆæœ‰è¶£ã€‚åŒæ—¶å› ä¸ºå¾ˆæ—©ä¹‹å‰çœ‹è¿‡[**jamiebuilds**](https://github.com/jamiebuilds)çš„[**the-super-tiny-compiler**](https://github.com/jamiebuilds/the-super-tiny-compiler)ï¼Œå°±æƒ³ç€èƒ½ä¸èƒ½è‡ªå·±ä¹Ÿå®ç°ä¸€ä¸ªç±»ä¼¼çš„æœ‰è¶£å¥½ç©ç®€å•çš„ç¼–è¯‘å™¨ã€‚æ‰€ä»¥å°±æœ‰äº†[**js-trailing-closure-toy-compiler**](https://github.com/dreamapplehappy/js-trailing-closure-toy-compiler)è¿™ä¸ªé¡¹ç›®ï¼Œä»¥åŠä»Šå¤©çš„è¿™ç¯‡æ–‡ç« ã€‚

å¯¹äºä¸ç†Ÿæ‚‰`Swift`çš„åŒå­¦æ¥è¯´ï¼Œæˆ‘å…ˆæ¥è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯`å°¾é—­åŒ…`ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¦‚æœä¸€ä¸ªå‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å°¾é—­åŒ…çš„æ–¹å¼æ¥ä¼ é€’æœ€åä¸€ä¸ªå‡½æ•°ã€‚å¤§å®¶å¯ä»¥çœ‹ä¸‹é¢çš„ä»£ç ç¤ºä¾‹ï¼š

```javascript
// ä¾‹å­ä¸­çš„ a è¡¨ç¤ºä¸€ä¸ªå‡½æ•°

// #1:ç®€å•ç‰ˆ
// Swift çš„æ–¹å¼
a(){
  // å°¾é—­åŒ…çš„å†…å®¹
}
// JavaScript çš„æ–¹å¼
a(() => {})

// #2:å‡½æ•°å¸¦å‚æ•°
// Swift çš„æ–¹å¼ï¼Œè¿™é‡Œå…ˆå¿½ç•¥å‚æ•°çš„ç±»å‹
a(1, 2, 3){
  // å°¾é—­åŒ…çš„å†…å®¹
}
// JavaScript çš„æ–¹å¼
a(1, 2, 3, () => {})

// #3:å°¾é—­åŒ…å¸¦æœ‰å‚æ•°
// Swift çš„æ–¹å¼ï¼Œè¿™é‡Œå…ˆå¿½ç•¥å‚æ•°çš„ç±»å‹
a(1, 2, 3){ arg1, arg2 in
  // å°¾é—­åŒ…çš„å†…å®¹
}
// JavaScript çš„æ–¹å¼
a(1, 2, 3, (arg1, arg2) => {})

```

å¦‚æœå…³äº`Swift`çš„å°¾é—­åŒ…è¿˜æœ‰ä»€ä¹ˆç–‘é—®çš„è¯ï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹å®˜æ–¹çš„æ–‡æ¡£[Closures](https://docs.swift.org/swift-book/LanguageGuide/Closures.html)ï¼Œé‡Œé¢è§£é‡Šçš„ä¹Ÿå¾ˆæ¸…æ¥šã€‚

æˆ‘è®°å¾—è‡ªå·±å¾ˆæ—©ä¹‹å‰å°±çœ‹è¿‡[the-super-tiny-compiler](https://github.com/jamiebuilds/the-super-tiny-compiler)é¡¹ç›®çš„æºç ï¼Œä¸è¿‡å½“æ—¶åªæ˜¯ç®€å•çš„çœ‹äº†ä¸€éã€‚å°±ä»¥ä¸ºè‡ªå·±æŒæ¡äº†é‡Œé¢çš„ä¸€äº›çŸ¥è¯†å’ŒåŸç†ã€‚ä½†æ˜¯å½“æˆ‘æƒ³å®ç°æˆ‘è‡ªå·±å¿ƒä¸­çš„è¿™ä¸ªæƒ³æ³•çš„æ—¶å€™ã€‚å´å‘ç°ä¹‹å‰å¹¶æ²¡æœ‰æŠŠè¿™ä¸ªé¡¹ç›®é‡Œé¢å®è·µçš„ä¸€äº›æ–¹æ³•å’ŒæŠ€å·§æŒæ¡å¥½ã€‚æ‰€ä»¥æˆ‘å†³å®šå…ˆå¥½å¥½çš„æŠŠè¿™ä¸ªé¡¹ç›®çš„æºç çœ‹æ‡‚ï¼Œç„¶åè‡ªå·±å…ˆå®ç°ä¸€ä¸ªè·ŸåŸæ¥çš„é¡¹ç›®åŠŸèƒ½ä¸€æ ·çš„æ ·ä¾‹ä¹‹åæ‰å¼€å§‹ç€æ‰‹å®ç°è‡ªå·±çš„å°ç¼–è¯‘å™¨ã€‚

**å‹æƒ…æç¤ºï¼Œæ¥ä¸‹æ¥çš„æ–‡ç« å†…å®¹æ¯”è¾ƒé•¿ï¼Œå»ºè®®æ”¶è—åå†ä»”ç»†é˜…è¯»**ã€‚

## ç¼–è¯‘å™¨çš„å®ç°è¿‡ç¨‹

ä»**the-super-tiny-compiler**æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼Œå¯¹äºä¸€èˆ¬çš„ç¼–è¯‘å™¨æ¥è¯´ã€‚ä¸»è¦æœ‰å››ä¸ªæ­¥éª¤å»å®Œæˆç¼–è¯‘çš„è¿‡ç¨‹ï¼Œè¿™å››ä¸ªæ­¥éª¤åˆ†åˆ«æ˜¯ï¼š

+ **tokenizerï¼šå°†æˆ‘ä»¬çš„ä»£ç æ–‡æœ¬å­—ç¬¦ä¸²è½¬æ¢æˆä¸€ä¸ªä¸ªæœ‰æ„ä¹‰çš„å•å…ƒï¼ˆä¹Ÿå°±æ˜¯`token`ï¼‰**ã€‚æ¯”å¦‚`if`ï¼Œ`"hello"`ï¼Œ`123`ï¼Œ`let`ï¼Œ`const`ç­‰ç­‰ã€‚
+ **parserï¼šå°†ä¸Šä¸€æ­¥è·å–åˆ°çš„`token`è½¬æ¢æˆå½“å‰è¯­è¨€çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œä¹Ÿå°±æ˜¯`AST`( Abstract Syntax Tree )**ã€‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºè¿™æ ·å¤„ç†ä¹‹åï¼Œæˆ‘ä»¬å°±çŸ¥é“ä»£ç ä¸­è¯­å¥çš„å…ˆåå…³ç³»å’Œå±‚çº§å…³ç³»ã€‚ä¹ŸçŸ¥é“è¿è¡Œçš„é¡ºåºï¼Œä»¥åŠä¸Šä¸‹æ–‡ç­‰ç­‰ç›¸å…³çš„ä¿¡æ¯äº†ã€‚
+ **transformerï¼šå°†ä¸Šä¸€æ­¥è·å–åˆ°çš„`AST`è½¬æ¢æˆç›®æ ‡è¯­è¨€çš„`AST`**ã€‚ä¸ºä»€ä¹ˆè¦åšè¿™ä¸€æ­¥å‘¢ï¼Ÿå¯¹äºç›¸åŒåŠŸèƒ½çš„ç¨‹åºè¯­å¥æ¥è¯´ï¼Œå¦‚æœé€‰æ‹©å®ç°çš„è¯­è¨€ä¸ä¸€æ ·ï¼Œé‚£å®ƒä»¬çš„è¯­æ³•å¤§æ¦‚ç‡ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚è¿™å°±å¯¼è‡´äº†å®ƒä»¬å¯¹åº”çš„æŠ½è±¡è¯­æ³•æ ‘ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšä¸€æ¬¡è½¬æ¢ï¼Œä¸ºäº†ä¸‹ä¸€æ­¥ç”Ÿæˆç›®æ ‡è¯­è¨€çš„ä»£ç åšå¥½å‡†å¤‡ã€‚
+ **codeGenerator**ï¼šè¿™ä¸€æ­¥ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ï¼ŒçŸ¥é“äº†ç›®æ ‡è¯­è¨€çš„è¯­æ³•ä¹‹åï¼Œæˆ‘ä»¬æ ¹æ®ä¸Šä¸€æ­¥éª¤ç”Ÿæˆçš„æ–°çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œå¯ä»¥æ–¹ä¾¿å¿«æ·çš„ç”Ÿæˆæˆ‘ä»¬æƒ³è¦çš„ç›®æ ‡è¯­è¨€çš„ä»£ç ã€‚

**ä¸Šé¢çš„æ­¥éª¤å°±æ˜¯ç¼–è¯‘å™¨çš„å¤§æ¦‚å·¥ä½œæµç¨‹äº†ï¼Œä½†æ˜¯ä»…ä»…çŸ¥é“è¿™äº›æµç¨‹è¿˜æ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦æˆ‘ä»¬äº²è‡ªåŠ¨æ‰‹å®è·µä¸€ä¸‹**ã€‚å¦‚æœçœ‹åˆ°è¿™é‡Œä½ æœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥ç‚¹å‡»è¿™é‡Œ[JavaScript Trailing Closure Toy Compiler](https://dreamapple.gitee.io/code-examples/2021/0404/)å…ˆä½“éªŒä¸€ä¸‹æœ€åå®ç°çš„æ•ˆæœã€‚å¦‚æœä½ å¯¹å…·ä½“çš„å®ç°è¿‡ç¨‹æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥ç»§ç»­ä¸‹é¢çš„é˜…è¯»ï¼Œç›¸ä¿¡çœ‹è¿‡ä¹‹åä½ ä¼šæœ‰å¾ˆå¤§çš„æ”¶è·çš„ï¼Œä¹Ÿè®¸ä¼šæƒ³è¦è‡ªå·±ä¹Ÿå®ç°ä¸€ä¸ªæœ‰è¶£çš„ç¼–è¯‘å™¨å‘¢ã€‚

### Tokenizerï¼šå°†ä»£ç å­—ç¬¦ä¸²è½¬æ¢ä¸º`token`

**é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç™½ä¸ºä»€ä¹ˆè¦æŠŠå­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ªä¸ªçš„`token`ï¼Œå› ä¸ºå¦‚æœä¸åšè½¬æ¢ï¼Œæˆ‘ä»¬å°±ä¸çŸ¥é“è¿™æ®µç¨‹åºè¦è¡¨ç¤ºçš„æ˜¯ä»€ä¹ˆæ„æ€ï¼Œå› ä¸º`token`æ˜¯ç†è§£ä¸€æ®µç¨‹åºçš„å¿…è¦æ¡ä»¶ã€‚**

è¿™å°±å¥½æ¯”`console.log("hello world!")`è¿™ä¸ªè¯­å¥æ¥è¯´ï¼Œæˆ‘ä»¬ä¸€çœ¼å°±çŸ¥é“å®ƒæ˜¯å¹²å˜›çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯æ€ä¹ˆæ€è€ƒçš„å‘¢ï¼Ÿæ˜¯ä¸æ˜¯é¦–å…ˆæ˜¯`console`æˆ‘ä»¬çŸ¥é“æ˜¯`console`å¯¹è±¡ï¼Œç„¶åæ˜¯`.`æˆ‘ä»¬çŸ¥é“æ˜¯è·å–å¯¹è±¡çš„å±æ€§æ“ä½œç¬¦ï¼Œå†ç„¶åæ˜¯`log`æ–¹æ³•ï¼Œç„¶åæ–¹æ³•çš„è°ƒç”¨éœ€è¦`(`å·¦æ‹¬å·ä½œä¸ºå¼€å§‹ï¼Œç„¶åæ˜¯`hello world!`å­—ç¬¦ä¸²ä¸ºå‚æ•°ï¼Œç„¶åé‡åˆ°äº†åé¢çš„`)`å³æ‹¬å·è¡¨ç¤ºç»“æŸã€‚

![ä»£ç å­—ç¬¦ä¸²è½¬æ¢ä¸ºtoken](./images/1.png)

æ‰€ä»¥æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆ`token`å°±æ˜¯ä¸ºäº†è®©æˆ‘ä»¬çŸ¥é“è¿™æ®µç¨‹åºè¦è¡¨ç¤ºçš„æ˜¯ä»€ä¹ˆæ„æ€ã€‚å› ä¸ºæ ¹æ®æ¯ä¸€ä¸ª`token`çš„å€¼ï¼Œä»¥åŠ`token`æ‰€å¤„çš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å‡†ç¡®çŸ¥é“è¿™ä¸ª`token`è¡¨ç¤ºçš„æ˜¯ä»€ä¹ˆï¼Œå®ƒæœ‰ä»€ä¹ˆä½œç”¨ã€‚

é‚£å¯¹äºæˆ‘ä»¬è¿™ä¸ªç¼–è¯‘å™¨æ¥è¯´ï¼Œç¬¬ä¸€æ­¥éœ€è¦æŠŠæˆ‘ä»¬æ‰€éœ€è¦çš„`token`åšä¸€ä¸ªåˆ’åˆ†ï¼Œé‚£ä¹ˆæ ¹æ®ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ã€‚æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬éœ€è¦çš„`token`çš„ç±»å‹æœ‰è¿™ä¹ˆå‡ ç§ï¼š

+ **æ•°å­—**ï¼šæ¯”å¦‚`1`ï¼Œ`66`ç­‰ã€‚
+ **å­—ç¬¦ä¸²**ï¼šæ¯”å¦‚`"hello"`ç­‰ã€‚
+ **æ ‡è¯†ç¬¦**ï¼šæ¯”å¦‚`a`ï¼Œåœ¨æˆ‘ä»¬è¿™ä¸ªç¼–è¯‘å™¨çš„ç¯å¢ƒä¸‹ï¼Œä¸€èˆ¬è¡¨ç¤ºå‡½æ•°åæˆ–è€…å˜é‡åã€‚
+ **å°æ‹¬å·**ï¼š`(`å’Œ`)`ï¼Œåœ¨è¿™é‡Œç”¨æ¥è¡¨ç¤ºå‡½æ•°çš„è°ƒç”¨ã€‚
+ **èŠ±æ‹¬å·**ï¼š`{`å’Œ`}`ï¼Œåœ¨è¿™é‡Œç”¨æ¥è¡¨ç¤ºå‡½æ•°ä½“ã€‚
+ **é€—å·**ï¼š`,`ï¼Œç”¨æ¥åˆ†å‰²å‚æ•°ã€‚
+ **ç©ºç™½ç¬¦**ï¼š` `ï¼Œç”¨æ¥åŒºåˆ†ä¸åŒçš„`token`ã€‚

å› ä¸ºæˆ‘ä»¬è¿™ä¸ªç¼–è¯‘å™¨æš‚æ—¶åªä¸“æ³¨äºæˆ‘ä»¬æƒ³è¦çš„å°¾é—­åŒ…çš„å®ç°ï¼Œæ‰€ä»¥æš‚æ—¶åªéœ€è¦å…³æ³¨ä¸Šé¢è¿™äº›`token`çš„ç±»å‹å°±å¯ä»¥äº†ã€‚

è¿™ä¸€æ­¥å…¶å®æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æŒ‰ç…§æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå¾ªç¯è¯»å–`token`ï¼Œä»£ç éƒ¨åˆ†å¦‚ä¸‹æ‰€ç¤ºï¼š

```javascript
// å°†å­—ç¬¦ä¸²è§£æä¸ºTokens
const tokenizer = (input) => {
    // ç®€å•çš„æ­£åˆ™
    const numReg = /\d/;
    const idReg = /[a-z]/i;
    const spaceReg = /\s/;

    // Tokens æ•°ç»„
    const tokens = [];

    // åˆ¤æ–­ input çš„é•¿åº¦
    const len = input.length;
    if (len > 0) {
        let cur = 0;
        while(cur < len) {
            let curChar = input[cur];

            // åˆ¤æ–­æ˜¯å¦æ˜¯æ•°å­—
            if (numReg.test(curChar)) {
                let num = '';
                while(numReg.test(curChar) && curChar) {
                    num += curChar;
                    curChar = input[++cur];
                }
                tokens.push({
                    type: 'NumericLiteral',
                    value: num
                });
                continue;
            }

            // åˆ¤æ–­æ˜¯å¦æ˜¯æ ‡è¯†ç¬¦
            if (idReg.test(curChar)) {
                let idVal = '';
                while(idReg.test(curChar) && curChar) {
                    idVal += curChar;
                    curChar = input[++cur];
                }

                // åˆ¤æ–­æ˜¯å¦æ˜¯ in å…³é”®å­—
                if (idVal === 'in') {
                    tokens.push({
                        type: 'InKeyword',
                        value: idVal
                    });
                } else {
                    tokens.push({
                        type: 'Identifier',
                        value: idVal
                    });
                }
                continue;
            }

            // åˆ¤æ–­æ˜¯å¦æ˜¯å­—ç¬¦ä¸²
            if (curChar === '"') {
                let strVal = '';
                curChar = input[++cur];
                while(curChar !== '"') {
                    strVal += curChar;
                    curChar = input[++cur];
                }
                tokens.push({
                    type: 'StringLiteral',
                    value: strVal
                });
                // éœ€è¦å¤„ç†å­—ç¬¦ä¸²çš„æœ€åä¸€ä¸ªåŒå¼•å·
                cur++;
                continue;
            }

            // åˆ¤æ–­æ˜¯å¦æ˜¯å·¦æ‹¬å·
            if (curChar === '(') {
                tokens.push({
                    type: 'ParenLeft',
                    value: '('
                });
                cur++;
                continue;
            }

            // åˆ¤æ–­æ˜¯å¦æ˜¯å³æ‹¬å·
            if (curChar === ')') {
                tokens.push({
                    type: 'ParenRight',
                    value: ')'
                });
                cur++;
                continue;
            }

            // åˆ¤æ–­æ˜¯å¦æ˜¯å·¦èŠ±æ‹¬å·
            if (curChar === '{') {
                tokens.push({
                    type: 'BraceLeft',
                    value: '{'
                });
                cur++;
                continue;
            }

            // åˆ¤æ–­æ˜¯å¦æ˜¯å³èŠ±æ‹¬å·
            if (curChar === '}') {
                tokens.push({
                    type: 'BraceRight',
                    value: '}'
                });
                cur++;
                continue;
            }

            // åˆ¤æ–­æ˜¯å¦æ˜¯é€—å·
            if (curChar === ',') {
                tokens.push({
                    type: 'Comma',
                    value: ','
                });
                cur++;
                continue;
            }

            // åˆ¤æ–­æ˜¯å¦æ˜¯ç©ºç™½ç¬¦å·
            if (spaceReg.test(curChar)) {
                cur++;
                continue;
            }

            throw new Error(`${curChar} is not a good character`);
        }
    }

    console.log(tokens, tokens.length);
    return tokens;
};
```

ä¸Šé¢çš„ä»£ç è™½ç„¶ä¸æ˜¯å¾ˆå¤æ‚ï¼Œä½†æ˜¯æœ‰ä¸€äº›éœ€è¦æ³¨æ„çš„ç‚¹ï¼Œå¦‚æœä¸ç»†å¿ƒå¾ˆå®¹æ˜“å‡ºé”™æˆ–è€…è¿›å…¥ä¸€ä¸ªæ­»å¾ªç¯ã€‚ä¸‹é¢æ˜¯æˆ‘è§‰å¾—ä¸€äº›å®¹æ˜“å‡ºç°é—®é¢˜çš„åœ°æ–¹ï¼š

+ **å¤–å±‚ä½¿ç”¨äº†`while`å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯å¼€å§‹æ—¶ä¼šé¦–å…ˆè·å–å½“å‰ä¸‹æ ‡å¯¹åº”çš„å­—ç¬¦**ã€‚ä¹‹æ‰€ä»¥æ²¡æœ‰ä½¿ç”¨`for`å¾ªç¯æ˜¯å› ä¸ºè¿™é‡Œå…³äºå½“å‰å­—ç¬¦çš„ä¸‹æ ‡`cur`æ˜¯ç”±é‡Œé¢çš„åˆ¤æ–­æ¥æ¨è¿›çš„ï¼Œä½¿ç”¨`while`æ›´æ–¹ä¾¿ä¸€äº›ã€‚
+ **å¦‚æœè¯»å–åˆ°å­—ç¬¦ä¸²ï¼Œæ•°å­—ä»¥åŠæ ‡è¯†ç¬¦çš„è¯ï¼Œéœ€è¦è¿›è¡Œå†…å¾ªç¯è¿›è¡Œè¿ç»­è¯»å–ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸æ˜¯å½“å‰æƒ³è¦çš„ç±»å‹ä¸ºæ­¢**ã€‚å› ä¸ºå¦‚æœè¯»å–çš„ç±»å‹å¯èƒ½ä¸æ­¢ä¸€ä¸ªå­—ç¬¦çš„è¯ï¼Œå°±éœ€è¦åˆ¤æ–­ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯å¦ç¬¦åˆå½“å‰çš„ç±»å‹ã€‚å¦‚æœä¸ç¬¦åˆçš„è¯ï¼Œå°±ç»ˆæ­¢å½“å‰ç±»å‹çš„è¯»å–ï¼Œä¸”éœ€è¦è·³å‡ºå½“å‰å¾ªç¯ï¼Œè¿›è¡Œä¸‹ä¸€è½®çš„å¤–å¾ªç¯ã€‚
+ **å¯¹äºå­—ç¬¦ä¸²æ¥è¯´ï¼Œåœ¨å­—ç¬¦ä¸²çš„å¼€å¤´å’Œç»“å°¾çš„`"`éœ€è¦è·³è¿‡ï¼Œä¸è®¡å…¥å­—ç¬¦ä¸²çš„å€¼é‡Œé¢ã€‚é‡åˆ°ç©ºç™½ç¬¦éœ€è¦è·³è¿‡**ã€‚

è¿™ä¸ªè¿‡ç¨‹æŠ€æœ¯éš¾åº¦ä¸å¤§ï¼Œéœ€è¦å¤šä¸€ç‚¹è€å¿ƒã€‚å®ç°å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹ï¼š

```javascript
tokenizer(`a(1){}`)
```

å¯ä»¥çœ‹åˆ°è¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼š

```javascript
(6) [{â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}]
0: {type: "Identifier", value: "a"}
1: {type: "ParenLeft", value: "("}
2: {type: "NumericLiteral", value: "1"}
3: {type: "ParenRight", value: ")"}
4: {type: "BraceLeft", value: "{"}
5: {type: "BraceRight", value: "}"}
```

å¯ä»¥çœ‹åˆ°è¾“å‡ºçš„ç»“æœæ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»æˆåŠŸäº†25%äº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯æŠŠå¾—åˆ°çš„`token`æ•°ç»„è½¬æ¢ä¸º`AST`æŠ½è±¡è¯­æ³•æ ‘ã€‚



### Parserï¼šå°†`token`æ•°ç»„è½¬æ¢ä¸º`AST`æŠ½è±¡è¯­æ³•æ ‘

æ¥ä¸‹æ¥çš„æ­¥éª¤å°±æ˜¯æŠŠ`token`æ•°ç»„è½¬æ¢ä¸º`AST(æŠ½è±¡è¯­æ³•æ ‘)`äº†ï¼Œè¿›è¡Œäº†ä¸Šä¸€ä¸ªæ­¥éª¤ä¹‹åï¼Œæˆ‘ä»¬æŠŠä»£ç å­—ç¬¦ä¸²ï¼Œè½¬å˜ä¸ºä¸€ä¸ªä¸ªæœ‰æ„ä¹‰çš„`token`ã€‚å½“æˆ‘ä»¬å¾—åˆ°äº†è¿™äº›`token`ä¹‹åï¼Œå°±å¯ä»¥æ ¹æ®æ¯ä¸€ä¸ª`token`è¡¨ç¤ºçš„æ„ä¹‰è¿›è€Œæ¨å¯¼å‡ºæ•´ä¸ªæŠ½è±¡è¯­æ³•æ ‘ã€‚ 

æ¯”å¦‚æˆ‘ä»¬é‡åˆ°äº†`{`ï¼Œæˆ‘ä»¬å°±çŸ¥é“åœ¨é‡åˆ°ä¸‹ä¸€ä¸ª`}`ä¸ºæ­¢ï¼Œè¿™ä¸­é—´çš„æ‰€æœ‰çš„`token`è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªå‡½æ•°çš„å‡½æ•°ä½“ï¼ˆæš‚æ—¶ä¸è€ƒè™‘å…¶å®ƒæƒ…å†µï¼‰ã€‚

ä¸‹å›¾æ‰€ç¤ºçš„`token`ç¤ºä¾‹ï¼š

![tokenç¤ºä¾‹](./images/2.png)

è¡¨ç¤ºçš„ç¨‹åºè¯­å¥åº”è¯¥æ˜¯ï¼š

```javascript
a(1) {
  // block
};
```



é‚£ä¹ˆå®ƒæ‰€å¯¹åº”çš„æŠ½è±¡è¯­æ³•æ ‘åº”è¯¥æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š

 ```javascript
{
  "type": "Program",
  "body": [
    {
      "type": "CallExpression",
      "value": "a",
      "params": [
        {
          "type": "NumericLiteral",
          "value": "1",
          "parentType": "ARGUMENTS_PARENT_TYPE"
        }
      ],
      "hasTrailingBlock": true,
      "trailingBlockParams": [],
      "trailingBody": []
    }
  ]
}
 ```

æˆ‘ä»¬å¯ä»¥ç®€å•çš„çœ‹ä¸€ä¸‹ä¸Šé¢çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œé¦–å…ˆæœ€å¤–å±‚çš„ç±»å‹æ˜¯`Program`ï¼Œç„¶å`body`é‡Œé¢çš„å†…å®¹å°±è¡¨ç¤ºæˆ‘ä»¬çš„ä»£ç å†…å®¹ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬çš„`body`æ•°ç»„åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œè¡¨ç¤ºçš„æ˜¯`CallExpression`ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ã€‚

è¿™ä¸ª`CallExpression`çš„å‡½æ•°åå­—æ˜¯`a`ï¼Œç„¶åå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹å€¼æ˜¯`NumericLiteral`ï¼Œæ•°å€¼æ˜¯`1`ã€‚è¿™ä¸ªå‚æ•°çš„çˆ¶èŠ‚ç‚¹ç±»å‹æ˜¯`ARGUMENTS_PARENT_TYPE`ï¼Œä¸‹é¢è¿˜ä¼šå¯¹è¿™ä¸ªå±æ€§è¿›è¡Œè§£é‡Šã€‚ç„¶åè¿™ä¸ª`CallExpression`çš„`hasTrailingBlock`å€¼ä¸º`true`ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå°¾é—­åŒ…å‡½æ•°è°ƒç”¨ã€‚ç„¶å`trailingBlockParams`è¡¨ç¤ºå°¾é—­åŒ…æ²¡æœ‰å‚æ•°ï¼Œ`trailingBody`è¡¨ç¤ºå°¾é—­åŒ…é‡Œé¢çš„å†…å®¹ä¸ºç©ºã€‚


ä¸Šé¢åªæ˜¯ä¸€ä¸ªç®€å•çš„è§£é‡Šï¼Œè¯¦ç»†çš„ä»£ç éƒ¨åˆ†å¦‚ä¸‹æ‰€ç¤ºï¼š

```javascript
// å°† Tokens è½¬æ¢ä¸º AST
const parser = (tokens) => {
    const ast = {
        type: 'Program',
        body: []
    };

    let cur = 0;

    const walk = () => {
        let token = tokens[cur];

        // æ˜¯æ•°å­—ç›´æ¥è¿”å›
        if (token.type === 'NumericLiteral') {
            cur++;
            return {
                type: 'NumericLiteral',
                value: token.value
            };
        }

        // æ˜¯å­—ç¬¦ä¸²ç›´æ¥è¿”å›
        if (token.type === 'StringLiteral') {
            cur++;
            return {
                type: 'StringLiteral',
                value: token.value
            };
        }

        // æ˜¯é€—å·ç›´æ¥è¿”å›
        if (token.type === 'Comma') {
            cur++;
            return;
        }

        // å¦‚æœæ˜¯æ ‡è¯†ç¬¦ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬åªæœ‰å‡½æ•°çš„è°ƒç”¨ï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­å‡½æ•°æœ‰æ²¡æœ‰å…¶å®ƒçš„å‚æ•°
        if (token.type === 'Identifier') {
            const callExp = {
                type: 'CallExpression',
                value: token.value,
                params: [],
                hasTrailingBlock: false,
                trailingBlockParams: [],
                trailingBody: []
            };
            // æŒ‡å®šèŠ‚ç‚¹å¯¹åº”çš„çˆ¶èŠ‚ç‚¹çš„ç±»å‹ï¼Œæ–¹ä¾¿åé¢çš„åˆ¤æ–­
            const specifyParentNodeType = () => {
                // è¿‡æ»¤é€—å·
                callExp.params = callExp.params.filter(p => p);
                callExp.trailingBlockParams = callExp.trailingBlockParams.filter(p => p);
                callExp.trailingBody = callExp.trailingBody.filter(p => p);

                callExp.params.forEach((node) => {
                    node.parentType = ARGUMENTS_PARENT_TYPE;
                });
                callExp.trailingBlockParams.forEach((node) => {
                    node.parentType = ARGUMENTS_PARENT_TYPE;
                });
                callExp.trailingBody.forEach((node) => {
                    node.parentType = BLOCK_PARENT_TYPE;
                });
            };
            const handleBraceBlock = () => {
                callExp.hasTrailingBlock = true;
                // æ”¶é›†é—­åŒ…å‡½æ•°çš„å‚æ•°
                token = tokens[++cur];
                const params = [];
                const blockBody = [];
                let isParamsCollected = false;
                while(token.type !== 'BraceRight') {
                    if (token.type === 'InKeyword') {
                        callExp.trailingBlockParams = params;
                        isParamsCollected = true;
                        token = tokens[++cur];
                    } else {
                        if (!isParamsCollected) {
                            params.push(walk());
                            token = tokens[cur];
                        } else {
                            // å¤„ç†èŠ±æ‹¬å·é‡Œé¢çš„æ•°æ®
                            blockBody.push(walk());
                            token = tokens[cur];
                        }
                    }
                }
                // å¦‚æœ isParamsCollected åˆ°è¿™é‡Œè¿˜æ˜¯ falseï¼Œè¯´æ˜èŠ±æ‹¬å·é‡Œé¢æ²¡æœ‰å‚æ•°
                if (!isParamsCollected) {
                    // å¦‚æœæ²¡æœ‰å‚æ•° æ”¶é›†çš„å°±ä¸æ˜¯å‚æ•°äº†
                    callExp.trailingBody = params;
                } else {
                    callExp.trailingBody = blockBody;
                }
                // å¤„ç†å³è¾¹çš„èŠ±æ‹¬å·
                cur++;
            };
            // åˆ¤æ–­åé¢ç´§æ¥ç€çš„ token æ˜¯ `(` è¿˜æ˜¯ `{`
            // éœ€è¦åˆ¤æ–­å½“å‰çš„ token æ˜¯å‡½æ•°è°ƒç”¨è¿˜æ˜¯å‚æ•°
            const next = tokens[cur + 1];
            if (next.type === 'ParenLeft' || next.type === 'BraceLeft') {
                token = tokens[++cur];
                if (token.type === 'ParenLeft') {
                    // éœ€è¦æ”¶é›†å‡½æ•°çš„å‚æ•°
                    // éœ€è¦åˆ¤æ–­ä¸‹ä¸€ä¸ª token æ˜¯å¦æ˜¯ `)`
                    token = tokens[++cur];
                    while(token.type !== 'ParenRight') {
                        callExp.params.push(walk());
                        token = tokens[cur];
                    }
                    // å¤„ç†å³è¾¹çš„åœ†æ‹¬å·
                    cur++;
                    // è·å– `)` åé¢çš„ token
                    token = tokens[cur];
                    // å¤„ç†åé¢çš„å°¾éƒ¨é—­åŒ…ï¼›éœ€è¦åˆ¤æ–­ token æ˜¯å¦å­˜åœ¨ è€ƒè™‘`func()`
                    if (token && token.type === 'BraceLeft') {
                        handleBraceBlock();
                    }
                } else {
                    handleBraceBlock();
                }
                // æŒ‡å®šèŠ‚ç‚¹å¯¹åº”çš„çˆ¶èŠ‚ç‚¹çš„ç±»å‹
                specifyParentNodeType();
                return callExp;
            } else {
                cur++;
                return {
                    type: 'Identifier',
                    value: token.value
                };
            }
        }

        throw new Error(`this ${token} is not a good token`);
    };

    while (cur < tokens.length) {
        ast.body.push(walk());
    }

    console.log(ast);
    return ast;
};
```

ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œæˆ‘æŠŠä¸€äº›å…³é”®çš„åœ°æ–¹éƒ½æ·»åŠ äº†ä¸€äº›æ³¨é‡Šã€‚ä¸‹é¢å†æ¬¡å¯¹ä¸Šé¢çš„ä»£ç åšä¸€äº›ç®€å•çš„è§£é‡Šã€‚

é¦–å…ˆæˆ‘ä»¬éœ€è¦å¯¹`tokens`æ•°ç»„è¿›è¡Œéå†ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†æŠ½è±¡è¯­æ³•æ ‘çš„æœ€å¤–å±‚çš„ç»“æ„æ˜¯ï¼š

```javascript
const ast = {
  type: 'Program',
  body: []
};
```

è¿™æ ·å®šä¹‰æ˜¯ä¸ºäº†åç»­çš„èŠ‚ç‚¹å¯¹è±¡èƒ½å¤ŸæŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ·»åŠ åˆ°æˆ‘ä»¬çš„æŠ½è±¡è¯­æ³•æ ‘ä¸Šã€‚

ç„¶åæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª`walk`å‡½æ•°ç”¨æ¥å¯¹`tokens`æ•°ç»„ä¸­çš„å…ƒç´ è¿›è¡Œéå†ã€‚å¯¹äº`walk`å‡½æ•°æ¥è¯´ï¼Œå¦‚æœç›´æ¥é‡åˆ°`æ•°å­—`ï¼Œ`å­—ç¬¦ä¸²`ï¼Œ`é€—å·`çš„è¯éƒ½æ˜¯ç›´æ¥è¿”å›çš„ã€‚å½“é‡åˆ°çš„`token`æ˜¯ä¸€ä¸ªæ ‡è¯†ç¬¦çš„è¯ï¼Œéœ€è¦åˆ¤æ–­çš„æƒ…å†µæ¯”è¾ƒå¤šã€‚

å¯¹äºä¸€ä¸ªæ ‡è¯†ç¬¦æ¥è¯´ï¼Œåœ¨æˆ‘ä»¬è¿™ç§æƒ…å¢ƒä¸‹æœ‰ä¸¤ç§å¤„ç†ï¼š

+ **ä¸€ç§æƒ…å†µå°±æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ ‡è¯†ç¬¦ï¼Œè¿™æ—¶å€™æ ‡è¯†ç¬¦åé¢ç´§è·Ÿçš„`token`æ—¢ä¸æ˜¯è¡¨ç¤º`(`çš„ï¼Œä¹Ÿä¸æ˜¯è¡¨ç¤º`{`çš„**ã€‚
+ **å¦ä¸€ç§æƒ…å†µè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨ï¼Œå¯¹äºå‡½æ•°çš„è°ƒç”¨æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘ä»¥ä¸‹è¿™å‡ ç§æƒ…å†µ**ï¼š
  + **ä¸€ç§æƒ…å†µæ˜¯å‡½æ•°åªæœ‰ä¸€ä¸ªå°¾é—­åŒ…ï¼Œä¸å«æœ‰å…¶å®ƒçš„å‚æ•°**ã€‚æ¯”å¦‚`a{}`ï¼›
  + **å¦ä¸€ç§æƒ…å†µæ˜¯å‡½æ•°çš„è°ƒç”¨ä¸å«æœ‰å°¾é—­åŒ…ï¼Œå¯ä»¥å«æœ‰å‚æ•°ä¹Ÿå¯ä»¥ä¸å¸¦å‚æ•°**ã€‚æ¯”å¦‚`a()`æˆ–è€…`a(1)`;
  + **æœ€åä¸€ç§å°±æ˜¯å‡½æ•°çš„è°ƒç”¨å«æœ‰å°¾é—­åŒ…**ã€‚æ¯”å¦‚`a{}`,`a(){}`,`a(1){}`ç­‰ç­‰ã€‚**å¯¹äºæœ‰å°¾é—­åŒ…çš„æƒ…å†µè¿˜éœ€è¦è€ƒè™‘å°¾éƒ¨é—­åŒ…æœ‰æ²¡æœ‰å‚æ•°**ï¼Œæ¯”å¦‚`a(1){b, c in }`ã€‚

æ¥ä¸‹æ¥ä¸»è¦å¯¹`token`æ˜¯æ ‡è¯†ç¬¦ç±»å‹çš„å¤„ç†åšä¸€ä¸ªç®€å•çš„è§£é‡Šï¼Œå¦‚æœåˆ¤æ–­`token`çš„ç±»å‹æ˜¯æ ‡è¯†ç¬¦çš„è¯ï¼Œæˆ‘ä»¬ä¼šå…ˆå®šä¹‰ä¸€ä¸ª`CallExpression`ç±»å‹çš„å¯¹è±¡`callExp`ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯ç”¨æ¥è¡¨ç¤ºæˆ‘ä»¬å‡½æ•°è°ƒç”¨çš„è¯­æ³•æ ‘å¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡æœ‰ä»¥ä¸‹å‡ ä¸ªå±æ€§ï¼š

+ **`type`**ï¼šè¡¨ç¤ºèŠ‚ç‚¹çš„ç±»å‹
+ **`value`**ï¼šè¡¨ç¤ºèŠ‚ç‚¹çš„åç§°ï¼Œè¿™é‡Œè¡¨ç¤ºå‡½æ•°å
+ **`params`**ï¼šè¡¨ç¤ºå‡½æ•°è°ƒç”¨çš„å‚æ•°
+ **`hasTrailingBlock`**ï¼šè¡¨ç¤ºå½“å‰å‡½æ•°è°ƒç”¨æ˜¯å¦åŒ…å«å°¾é—­åŒ…
+ **`trailingBlockParams`**ï¼šè¡¨ç¤ºå°¾é—­åŒ…æ˜¯å¦å«æœ‰å‚æ•°
+ **`trailingBody`**ï¼šå°¾é—­åŒ…é‡Œé¢çš„å†…å®¹

æ¥ä¸‹æ¥åˆ¤æ–­æ ‡è¯†ç¬¦åé¢çš„`token`ç±»å‹æ˜¯ä»€ä¹ˆï¼Œå¦‚æœæ˜¯å‡½æ•°çš„è°ƒç”¨çš„è¯ï¼Œå½“å‰`token`åé¢çš„`token`å¿…é¡»æ˜¯`(`æˆ–è€…æ˜¯`{`ã€‚å¦‚æœä¸æ˜¯çš„è¯ï¼Œæˆ‘ä»¬ç›´æ¥è¿”å›è¿™ä¸ªæ ‡è¯†ç¬¦ã€‚

**å¦‚æœæ˜¯å‡½æ•°çš„è°ƒç”¨ï¼Œæˆ‘ä»¬éœ€è¦åšä¸¤ä¸ªäº‹æƒ…ï¼Œä¸€ä¸ªæ˜¯æ”¶é›†å‡½æ•°è°ƒç”¨çš„å‚æ•°ï¼Œä¸€ä¸ªæ˜¯åˆ¤æ–­å‡½æ•°è°ƒç”¨åé¢æ˜¯ä¸æ˜¯å«æœ‰å°¾é—­åŒ…**ã€‚å¯¹äºå‡½æ•°å‚æ•°çš„æ”¶é›†æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆåˆ¤æ–­å½“å‰`token`åé¢çš„`token`æ˜¯ä¸æ˜¯è¡¨ç¤ºçš„æ˜¯`(`ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå¼€å§‹æ”¶é›†å‚æ•°ï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ª`token`çš„ç±»å‹æ˜¯`)`è¡¨ç¤ºå‚æ•°æ”¶é›†ç»“æŸã€‚**è¿˜è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå› ä¸ºå‚æ•°æœ‰å¯èƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æ”¶é›†å‚æ•°çš„æ—¶å€™å†æ¬¡è°ƒç”¨`walk`å‡½æ•°ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬é€’å½’çš„è¿›è¡Œå‚æ•°çš„å¤„ç†**ã€‚

æ¥ä¸‹æ¥å°±æ˜¯åˆ¤æ–­å‡½æ•°è°ƒç”¨åé¢æ˜¯å¦å«æœ‰å°¾é—­åŒ…ï¼Œå¯¹äºå°¾é—­åŒ…çš„åˆ¤æ–­æœ‰ä¸¤ç§æƒ…å†µéœ€è¦è€ƒè™‘ï¼š**ä¸€ç§å°±æ˜¯å‡½æ•°çš„è°ƒç”¨å«æœ‰æœ‰å‚æ•°ï¼Œåœ¨å‚æ•°çš„åé¢å«æœ‰å°¾é—­åŒ…ï¼›å¦ä¸€ç§æ˜¯å‡½æ•°çš„è°ƒç”¨æ²¡æœ‰å‚æ•°ï¼Œç›´æ¥å°±æ˜¯ä¸€ä¸ªå°¾é—­åŒ…ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸¤ç§æƒ…å†µéƒ½åšä¸€ä¸‹å¤„ç†**ã€‚

æ—¢ç„¶æœ‰ä¸¤ä¸ªåœ°æ–¹éƒ½è¦è¿›è¡Œæ˜¯å¦æ˜¯å°¾é—­åŒ…çš„åˆ¤æ–­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™éƒ¨åˆ†çš„é€»è¾‘æŠ½ç¦»åˆ°`handleBraceBlock`å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯å¸®åŠ©æˆ‘ä»¬æ¥è¿›è¡Œå°¾é—­åŒ…çš„å¤„ç†ã€‚æ¥ä¸‹æ¥æ¥è§£é‡Šä¸€ä¸‹å°¾é—­åŒ…æ˜¯å¦‚ä½•è¿›è¡Œå¤„ç†çš„ã€‚

å¦‚æœæˆ‘ä»¬åˆ¤æ–­ä¸‹ä¸€ä¸ª`token`æ˜¯`{`é‚£ä¹ˆè¯´æ˜æˆ‘ä»¬éœ€è¦è¿›è¡Œå°¾é—­åŒ…çš„å¤„ç†äº†ï¼Œæˆ‘ä»¬é¦–å…ˆæŠŠ`callExp`å¯¹è±¡çš„`hasTrailingBlock`å±æ€§çš„å€¼è®¾ç½®ä¸º`true`ï¼›ç„¶åéœ€è¦åˆ¤æ–­å°¾é—­åŒ…æ˜¯å¦å«æœ‰å‚æ•°ï¼Œå¹¶ä¸”éœ€è¦å¤„ç†å°¾é—­åŒ…çš„å†…éƒ¨å†…å®¹ã€‚

å¦‚ä½•æ”¶é›†å°¾é—­åŒ…çš„å‚æ•°å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦åˆ¤æ–­åœ¨å°¾é—­åŒ…é‡Œé¢æ˜¯å¦å«æœ‰`in`å…³é”®å­—ï¼Œå¦‚æœå«æœ‰`in`å…³é”®å­—ï¼Œé‚£å°±è¯´æ˜å°¾é—­åŒ…é‡Œé¢å«æœ‰å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰å°±è¡¨ç¤ºå°¾é—­åŒ…é‡Œä¸å«æœ‰å‚æ•°ï¼Œåªéœ€è¦å¤„ç†å°¾é—­åŒ…å†…éƒ¨çš„å†…å®¹å³å¯ã€‚

åˆå› ä¸ºæˆ‘ä»¬åˆšå¼€å§‹ä¸çŸ¥é“å°¾é—­åŒ…ä¸­æ˜¯å¦å«æœ‰`in`å…³é”®å­—ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€å¼€å§‹æ”¶é›†çš„å†…å®¹å¯èƒ½æ˜¯å°¾é—­åŒ…é‡Œé¢çš„å†…å®¹ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å‚æ•°ï¼›æ‰€ä»¥å½“åœ¨é‡åˆ°`}`å°¾é—­åŒ…çš„ç»“æŸ`token`ä¹‹åï¼Œè¿™æœŸé—´å¦‚æœæ²¡æœ‰`in`å…³é”®å­—ï¼Œé‚£è¯´æ˜æˆ‘ä»¬æ”¶é›†åˆ°çš„éƒ½æ˜¯å°¾é—­åŒ…çš„å†…å®¹ã€‚

æ— è®ºæ˜¯æ”¶é›†å°¾é—­åŒ…çš„å‚æ•°è¿˜æ˜¯å†…å®¹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ä½¿ç”¨`walk`å‡½æ•°æ¥è¿›è¡Œé€’å½’æ“ä½œï¼Œå› ä¸ºå‚æ•°å’Œå†…å®¹éƒ½å¯èƒ½ä¸æ˜¯åŸºæœ¬çš„æ•°å€¼ç±»å‹å€¼ï¼ˆä¸ºäº†ç®€åŒ–æ“ä½œï¼Œæˆ‘ä»¬è¿™é‡Œå¯¹å°¾é—­åŒ…çš„å‚æ•°ä¹Ÿä½¿ç”¨`walk`æ¥è¿›è¡Œé€’å½’æ“ä½œï¼‰ã€‚

åœ¨è¿”å›`callExp`å¯¹è±¡ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨`specifyParentNodeType`å¸®åŠ©å‡½æ•°é¢å¤–çš„åšä¸€ä¸‹å¤„ç†ã€‚ç¬¬ä¸€ä¸ªå¤„ç†æ˜¯å»æ‰è¡¨ç¤º`,`çš„`token`ï¼Œå¦ä¸€ä¸ªæ“ä½œå°±æ˜¯éœ€è¦ç»™`callExp`å¯¹è±¡çš„`params`ï¼Œ`trailingBlockParams`å’Œ`trailingBody`å±æ€§ä¸­çš„èŠ‚ç‚¹æŒ‡å®šä¸€ä¸‹çˆ¶èŠ‚ç‚¹çš„ç±»å‹ï¼Œå¯¹äº`params`å’Œ`trailingBlockParams`æ¥è¯´ï¼Œå®ƒä»¬çš„çˆ¶èŠ‚ç‚¹ç±»å‹éƒ½æ˜¯`ARGUMENTS_PARENT_TYPE`ç±»å‹çš„ï¼›å¯¹äº`trailingBody`æ¥è¯´ï¼Œå®ƒçš„çˆ¶èŠ‚ç‚¹ç±»å‹æ˜¯`BLOCK_PARENT_TYPE`ç±»å‹çš„ã€‚è¿™æ ·çš„å¤„ç†æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œã€‚åœ¨è¿›è¡Œä¸‹é¢æ­¥éª¤è®²è§£çš„æ—¶å€™æˆ‘ä»¬ä¼šå†æ¬¡å¯¹å…¶è¿›è¡Œè¯´æ˜ã€‚

### Transformerï¼šå°†æ—§ AST è½¬æ¢ä¸ºç›®æ ‡è¯­è¨€çš„ AST

æ¥ä¸‹æ¥å°±æ˜¯æŠŠæˆ‘ä»¬è·å–åˆ°çš„åŸå§‹`AST`è½¬æ¢ä¸ºç›®æ ‡è¯­è¨€çš„`AST`ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦åšè¿™ä¸€æ­¥å¤„ç†å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºåŒæ ·çš„ç¼–ç é€»è¾‘ï¼Œåœ¨ä¸åŒçš„å®¿ä¸»è¯­è¨€çš„è¡¨ç°æ˜¯ä¸ä¸€æ ·çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¦æŠŠåŸå§‹çš„`AST`è½¬æ¢æˆæˆ‘ä»¬ç›®æ ‡è¯­è¨€çš„`AST`ã€‚

é‚£æˆ‘ä»¬æ€ä¹ˆè¿›è¡Œæ“ä½œå‘¢ï¼ŸåŸå§‹çš„`AST`æ˜¯ä¸€ä¸ªæ ‘å½¢çš„ç»“æ„ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸ªæ ‘å½¢çš„ç»“æ„è¿›è¡Œéå†ï¼›éå†éœ€è¦ä½¿ç”¨æ·±åº¦ä¼˜å…ˆçš„éå†ï¼Œå› ä¸ºå¯¹äºä¸€ä¸ªåµŒå¥—çš„ç»“æ„æ¥è¯´ï¼Œåªæœ‰å°†é‡Œé¢çš„å†…å®¹ç¡®å®šäº†ä¹‹åï¼Œå¤–é¢çš„å†…å®¹æ‰èƒ½å¤Ÿéšä¹‹ç¡®å®šã€‚

è¿™é‡Œå¯¹æ ‘å½¢ç»“æ„çš„éå†æˆ‘ä»¬ä¼šç”¨åˆ°ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œé‚£å°±æ˜¯[**è®¿é—®è€…æ¨¡å¼**](https://en.wikipedia.org/wiki/Visitor_pattern)ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè®¿é—®è€…å¯¹è±¡å¯¹æˆ‘ä»¬çš„æ ‘å½¢å¯¹è±¡è¿›è¡Œæ·±åº¦ä¼˜å…ˆçš„éå†ï¼Œè¿™ä¸ªè®¿é—®è€…å¯¹è±¡æœ‰é’ˆå¯¹ä¸åŒç±»å‹èŠ‚ç‚¹çš„å¤„ç†å‡½æ•°ï¼Œå½“é‡åˆ°ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šæ ¹æ®å½“å‰èŠ‚ç‚¹çš„ç±»å‹ï¼Œä»è®¿é—®è€…å¯¹è±¡èº«ä¸Šè·å–ç›¸åº”çš„å¤„ç†å‡½æ•°å¯¹è¿™ä¸ªèŠ‚ç‚¹è¿›è¡Œå¤„ç†ã€‚

æˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹å¦‚ä½•å¯¹åŸå§‹çš„æ ‘å½¢ç»“æ„è¿›è¡Œéå†ï¼Œå¯¹äºåŸæ¥çš„æ ‘å½¢ç»“æ„æ¥è¯´ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹è¦ä¹ˆæ˜¯ä¸€ä¸ªå…·ä½“ç±»å‹çš„å¯¹è±¡ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªæ•°ç»„ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å¯¹è¿™ä¸¤ç§æƒ…å†µåˆ†åˆ«è¿›è¡Œå¤„ç†ã€‚æˆ‘ä»¬é¦–å…ˆç¡®å®šå¦‚ä½•è¿›è¡Œæ ‘å½¢ç»“æ„çš„éå†ï¼Œè¿™éƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```javascript
// éå†èŠ‚ç‚¹
const traverser = (ast, visitor) => {
    const traverseNode = (node, parent) => {

        const method = visitor[node.type];
        if (method && method.enter) {
            method.enter(node, parent);
        }

        const t = node.type;
        switch (t) {
            case 'Program':
                traverseArr(node.body, node);
                break;
            case 'CallExpression':
                // å¤„ç† ArrowFunctionExpression
                // TODO è€ƒè™‘body é‡Œé¢å­˜åœ¨å°¾éƒ¨é—­åŒ…
                if (node.hasTrailingBlock) {
                    node.params.push({
                        type: 'ArrowFunctionExpression',
                        parentType: ARGUMENTS_PARENT_TYPE,
                        params: node.trailingBlockParams,
                        body: node.trailingBody
                    });
                    traverseArr(node.params, node);
                } else {
                    traverseArr(node.params, node);
                }
                break;
            case 'ArrowFunctionExpression':
                traverseArr(node.params, node);
                traverseArr(node.body, node);
                break;
            case 'Identifier':
            case 'NumericLiteral':
            case 'StringLiteral':
                break;
            default:
                throw new Error(`this type ${t} is not a good type`);
        }

        if (method && method.exit) {
            method.exit(node, parent);
        }
    };
    const traverseArr = (arr, parent) => {
        arr.forEach((node) => {
            traverseNode(node, parent);
        });
    };
    traverseNode(ast, null);
};
```

æˆ‘æ¥ç®€å•è§£é‡Šä¸€ä¸‹è¿™ä¸ª`traverser`å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å†…éƒ¨å®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªæ˜¯`traverseNode`ï¼Œä¸€ä¸ªæ˜¯`traverseArr`ã€‚`traverseArr`å‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œå¦‚æœå½“å‰çš„èŠ‚ç‚¹æ˜¯ä¸€ä¸ªæ•°ç»„çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°ç»„é‡Œé¢çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹åˆ†åˆ«è¿›è¡Œå¤„ç†ã€‚

èŠ‚ç‚¹çš„ä¸»è¦å¤„ç†é€»è¾‘éƒ½åœ¨`traverseNode`é‡Œé¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°éƒ½åšäº†å“ªäº›äº‹æƒ…ï¼Ÿé¦–å…ˆæ ¹æ®èŠ‚ç‚¹çš„ç±»å‹ï¼Œä»`visitor`å¯¹è±¡ä¸Šè·å–å¯¹åº”èŠ‚ç‚¹çš„å¤„ç†æ–¹æ³•ã€‚ç„¶åå¯¹æ¥ç‚¹ç±»å‹è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœèŠ‚ç‚¹çš„ç±»å‹æ˜¯åŸºæœ¬ç±»å‹çš„è¯ï¼Œå°±ä¸åšå¤„ç†ï¼›å¦‚æœèŠ‚ç‚¹çš„ç±»å‹æ˜¯`ArrowFunctionExpression`ç®­å¤´å‡½æ•°çš„è¯ï¼Œéœ€è¦ä¾æ¬¡éå†è¿™ä¸ªèŠ‚ç‚¹çš„`params`å’Œ`body`å±æ€§ã€‚å¦‚æœèŠ‚ç‚¹çš„ç±»å‹æ˜¯`CallExpression`çš„è¯ï¼Œè¡¨ç¤ºå½“å‰çš„èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åˆ¤æ–­è¿™ä¸ªå‡½æ•°è°ƒç”¨æ˜¯å¦åŒ…å«å°¾é—­åŒ…ï¼Œå¦‚æœåŒ…å«å°¾é—­åŒ…çš„è¯ï¼Œé‚£å°±è¯´æ˜æˆ‘ä»¬åŸæ¥çš„å‡½æ•°è°ƒç”¨éœ€è¦é¢å¤–æ·»åŠ ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç®­å¤´å‡½æ•°ã€‚æ‰€ä»¥ä¼šæœ‰ä¸‹é¢è¿™æ ·ä¸€æ®µä»£ç è¿›è¡Œåˆ¤æ–­ï¼š

```javascript
// ...
if (node.hasTrailingBlock) {
    node.params.push({
        type: 'ArrowFunctionExpression',
        parentType: ARGUMENTS_PARENT_TYPE,
        params: node.trailingBlockParams,
        body: node.trailingBody
    });
    traverseArr(node.params, node);
} else {
    traverseArr(node.params, node);
}
// ...
```

ç„¶åå°±æ˜¯å¯¹è¿™ä¸ª`CallExpression`èŠ‚ç‚¹çš„`params`å±æ€§è¿›è¡Œéå†ã€‚å½“å‡½æ•°çš„è°ƒç”¨åŒ…å«å°¾é—­åŒ…çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾€èŠ‚ç‚¹çš„`params`å±æ€§é‡Œæ·»åŠ äº†ä¸€ä¸ªç±»å‹æ˜¯`ArrowFunctionExpression`çš„å¯¹è±¡ï¼Œè€Œä¸”è¿™ä¸ªå¯¹è±¡çš„`parentType`çš„å€¼æ˜¯`ARGUMENTS_PARENT_TYPE`ï¼Œå› ä¸ºè¿™æ ·æˆ‘ä»¬å°±çŸ¥é“è¿™ä¸ªå¯¹è±¡çš„çˆ¶èŠ‚ç‚¹ç±»å‹ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä¸‹é¢è¿›è¡Œè¯­æ³•æ ‘è½¬æ¢æ—¶ä½¿ç”¨ã€‚

å†æ¥ä¸‹æ¥å°±æ˜¯å®šä¹‰è®¿é—®è€…å¯¹è±¡ä¸Šé¢ä¸åŒèŠ‚ç‚¹ç±»å‹çš„å¤„ç†æ–¹æ³•äº†ï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```javascript
const transformer = (ast) => {
    const newAst = {
        type: 'Program',
        body: []
    };

    ast._container = newAst.body;

    const getNodeContainer = (node, parent) => {
        const parentType = node.parentType;
        if (parentType) {
            if (parentType === BLOCK_PARENT_TYPE) {
                return parent._bodyContainer;
            }
            if (parentType === ARGUMENTS_PARENT_TYPE) {
                return parent._argumentsContainer;
            }
        } else {
            return parent._container;
        }
    };

    traverser(ast, {
        NumericLiteral: {
            enter: (node, parent) => {
                getNodeContainer(node, parent).push({
                    type: 'NumericLiteral',
                    value: node.value
                });
            }
        },
        StringLiteral: {
            enter: (node, parent) => {
                getNodeContainer(node, parent).push({
                    type: 'StringLiteral',
                    value: node.value
                });
            }
        },
        Identifier: {
            enter: (node, parent) => {
                getNodeContainer(node, parent).push({
                    type: 'Identifier',
                    name: node.value
                });
            }
        },
        CallExpression: {
            enter: (node, parent) => {
                // TODO ä¼˜åŒ–ä¸€ä¸‹
                const callExp = {
                    type: 'CallExpression',
                    callee: {
                        type: 'Identifier',
                        name: node.value
                    },
                    arguments: [],
                    blockBody: []
                };
                // ç»™å‚æ•°æ·»åŠ  _container
                node._argumentsContainer = callExp.arguments;
                node._bodyContainer = callExp.blockBody;
                getNodeContainer(node, parent).push(callExp);
            }
        },
        ArrowFunctionExpression: {
            enter: (node, parent) => {
                // TODO ä¼˜åŒ–ä¸€ä¸‹
                const arrowFunc = {
                    type: 'ArrowFunctionExpression',
                    arguments: [],
                    blockBody: []
                };
                // ç»™å‚æ•°æ·»åŠ  _container
                node._argumentsContainer = arrowFunc.arguments;
                node._bodyContainer = arrowFunc.blockBody;
                getNodeContainer(node, parent).push(arrowFunc);
            }
        }
    });
    console.log(newAst);
    return newAst;
};
```

æˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†æ–°çš„`AST`çš„å¤–å±‚å±æ€§ï¼Œç„¶åæ˜¯`ast._container = newAst.body`ï¼Œè¿™ä¸ªæ“ä½œçš„ä½œç”¨æ˜¯å°†æ—§çš„`AST`å’Œæ–°çš„`AST`æœ€å¤–å±‚è¿›è¡Œå…³è”ï¼Œå› ä¸ºæˆ‘ä»¬éå†çš„æ˜¯æ—§çš„`AST`ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡`_container`å±æ€§æŒ‡å‘æ–°çš„`AST`ã€‚è¿™æ ·æˆ‘ä»¬å‘`_container`é‡Œé¢æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨æ–°çš„`AST`ä¸Šæ·»åŠ å¯¹åº”çš„èŠ‚ç‚¹ã€‚è¿™æ ·å¤„ç†å¯¹æˆ‘ä»¬æ¥è¯´ç›¸å¯¹æ¯”è¾ƒç®€å•ä¸€ç‚¹ã€‚

ç„¶åå°±æ˜¯`getNodeContainer`å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯è·å–å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„`_container`å±æ€§ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹çš„`parentType`å±æ€§ä¸ä¸ºç©ºï¼Œé‚£è¯´æ˜å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹è¡¨ç¤ºçš„å¯èƒ½æ˜¯å‡½æ•°è°ƒç”¨çš„å‚æ•°ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å°¾é—­åŒ…é‡Œé¢çš„å†…å®¹ã€‚è¿™æ—¶å¯ä»¥æ ¹æ®`node.parentType`çš„ç±»å‹è¿›è¡Œåˆ¤æ–­ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹çš„`parentType`å±æ€§ä¸ºç©ºï¼Œé‚£å°±è¯´æ˜å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„`_container`å±æ€§å°±æ˜¯çˆ¶èŠ‚ç‚¹çš„`_container`å±æ€§ã€‚

æ¥ä¸‹æ¥å°±æ˜¯`visitor`å¯¹è±¡ä¸Šé¢ä¸åŒèŠ‚ç‚¹ç±»å‹çš„å¤„ç†æ–¹æ³•äº†ï¼Œå¯¹äºåŸºæœ¬ç±»å‹è¿˜æ˜¯ç›´æ¥è¿”å›å¯¹åº”çš„èŠ‚ç‚¹å°±å¯ä»¥äº†ã€‚å¦‚æœæ˜¯`CallExpression`å’Œ`ArrowFunctionExpression`ç±»å‹çš„è¯ï¼Œå°±éœ€è¦ä¸€äº›é¢å¤–çš„å¤„ç†äº†ã€‚

é¦–å…ˆå¯¹äº`ArrowFunctionExpression`ç±»å‹èŠ‚ç‚¹æ¥è¯´ï¼Œé¦–å…ˆå£°æ˜äº†ä¸€ä¸ª`arrowFunc`å¯¹è±¡ï¼Œç„¶åå°†å¯¹åº”èŠ‚ç‚¹çš„`_argumentsContainer`å±æ€§æŒ‡å‘`arrowFunc`å¯¹è±¡çš„`arguments`å±æ€§ï¼›å°†èŠ‚ç‚¹çš„`_bodyContainer`å±æ€§æŒ‡å‘`arrowFunc`å¯¹è±¡çš„`blockBody`å±æ€§ã€‚ç„¶åè·å–å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„`_container`å±æ€§ï¼Œæœ€åå°†`arrowFunc`æ·»åŠ åˆ°è¿™ä¸ªå±æ€§ä¸Šã€‚å¯¹äºèŠ‚ç‚¹ç±»å‹æ˜¯`CallExpression`çš„èŠ‚ç‚¹çš„å¤„ç†è·Ÿä¸Šé¢çš„ç±»ä¼¼ï¼Œåªä¸è¿‡å®šä¹‰çš„å¯¹è±¡å¤šäº†ä¸€ä¸ª`callee`å±æ€§ï¼Œè¡¨æ˜å‡½æ•°è°ƒç”¨çš„å‡½æ•°åç§°ã€‚

åˆ°æ­¤ä¸ºæ­¢å°†æ—§çš„`AST`è½¬æ¢ä¸ºæ–°çš„`AST`å°±å®Œæˆäº†ã€‚

### CodeGeneratorï¼šéå†æ–°çš„ AST ç”Ÿæˆä»£ç 

è¿™ä¸€æ­¥å°±æ¯”è¾ƒç®€å•äº†ï¼Œæ ¹æ®èŠ‚ç‚¹çš„ç±»å‹æ‹¼æ¥å¯¹åº”ç±»å‹çš„ä»£ç å°±å¯ä»¥äº†ï¼›è¯¦ç»†çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```javascript
const codeGenerator = (node) => {
    const type = node.type;
    switch (type) {
        case 'Program':
            return node.body.map(codeGenerator).join(';\n');
        case 'Identifier':
            return node.name;
        case 'NumericLiteral':
            return node.value;
        case 'StringLiteral':
            return `"${node.value}"`;
        case 'CallExpression':
            return `${codeGenerator(node.callee)}(${node.arguments.map(codeGenerator).join(', ')})`;
        case 'ArrowFunctionExpression':
            return `(${node.arguments.map(codeGenerator).join(', ')}) => {${node.blockBody.map(codeGenerator).join(';')}}`;
        default:
            throw new Error(`this type ${type} is not a good type`);
    }
};
```

éœ€è¦æ³¨æ„çš„å¯èƒ½å°±æ˜¯å¯¹äº`CallExpression`å’Œ`ArrowFunctionExpression`èŠ‚ç‚¹çš„å¤„ç†äº†ï¼Œå¯¹äº`CallExpression`éœ€è¦æ·»åŠ å‡½æ•°çš„åç§°ï¼Œç„¶åæ¥ä¸‹æ¥å°±æ˜¯å‡½æ•°è°ƒç”¨çš„å‚æ•°äº†ã€‚å¯¹äº`ArrowFunctionExpression`æ¥è¯´ï¼Œéœ€è¦å¤„ç†ç®­å¤´å‡½æ•°çš„å‚æ•°ä»¥åŠå‡½æ•°ä½“çš„å†…å®¹ã€‚ç›¸æ¯”ä¸Šé¢çš„ä¸‰ä¸ªæ­¥éª¤æ¥è¯´ï¼Œè¿™ä¸ªæ­¥éª¤è¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒç®€å•çš„ã€‚

æ¥ä¸‹æ¥å°±æ˜¯å°†è¿™å››ä¸ªæ­¥éª¤ç»„åˆä¸€ä¸‹ï¼Œè¿™ä¸ªç®€å•çš„ç¼–è¯‘å™¨å°±ç®—å®Œæˆäº†ã€‚å…·ä½“çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```javascript
// ç»„è£…
const compiler = (input) => {
    const tokens = tokenizer(input);
    const ast = parser(tokens);
    const newAst = transformer(ast);
    return codeGenerator(newAst);
};

// å¯¼å‡ºå¯¹åº”çš„æ¨¡å—
module.exports = {
    tokenizer,
    parser,
    transformer,
    codeGenerator,
    compiler
};
```

### ç®€å•æ€»ç»“

å¦‚æœä½ æœ‰è€å¿ƒçœ‹å®Œçš„è¯ï¼Œä½ ä¼šå‘ç°å®Œæˆä¸€ä¸ªç®€å•çš„ç¼–è¯‘å™¨å…¶å®ä¹Ÿæ²¡æœ‰å¾ˆå¤æ‚ã€‚**æˆ‘ä»¬éœ€è¦æŠŠè¿™å››ä¸ªè¿‡ç¨‹è¦åšä»€ä¹ˆç†æ¸…æ¥šï¼Œç„¶åæ³¨æ„ä¸€äº›ç‰¹æ®Šçš„åœ°æ–¹éœ€è¦åšç‰¹æ®Šçš„å¤„ç†ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯éœ€è¦ä¸€ç‚¹è€å¿ƒäº†**ã€‚

å½“ç„¶æˆ‘ä»¬è¿™ä¸ªç‰ˆæœ¬çš„å®ç°åªæ˜¯ç®€å•çš„å®Œæˆäº†æˆ‘ä»¬æƒ³è¦çš„é‚£éƒ¨åˆ†åŠŸèƒ½ï¼Œå®é™…ä¸ŠçœŸæ­£çš„ç¼–è¯‘å™¨è¦è€ƒè™‘çš„ä¸œè¥¿æ˜¯éå¸¸å¤šçš„ã€‚ä¸Šé¢è¿™ä¸ªç‰ˆæœ¬çš„ä»£ç æœ‰å¾ˆå¤šåœ°æ–¹ä¹Ÿä¸æ˜¯å¾ˆè§„èŒƒï¼Œå½“åˆå®ç°çš„æ—¶å€™å…ˆè€ƒè™‘å¦‚ä½•å®ç°ï¼Œç»†èŠ‚å’Œå¯ç»´æŠ¤æ€§æ²¡æœ‰è€ƒè™‘å¤ªå¤šã€‚å¦‚æœä½ æœ‰ä»€ä¹ˆå¥½çš„æƒ³æ³•ï¼Œæˆ–è€…å‘ç°äº†ä»€ä¹ˆé”™è¯¯æ¬¢è¿ç»™è¿™ä¸ªå°é¡¹ç›®æ[Issues](https://github.com/dreamapplehappy/js-trailing-closure-toy-compiler/issues)æˆ–è€…[Pull Request](https://github.com/dreamapplehappy/js-trailing-closure-toy-compiler/pulls)ï¼Œè®©è¿™ä¸ªå°é¡¹ç›®å˜å¾—æ›´å¥½ä¸€ç‚¹ã€‚ä¹Ÿæ¬¢è¿å¤§å®¶åœ¨æ–‡ç« ä¸‹é¢ç•™è¨€ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯èƒ½ç¢°æ’å‡ºä»€ä¹ˆæ–°çš„æ€è·¯ä¸æƒ³æ³•ã€‚

ä¸€äº›åŒå­¦å¯èƒ½ä¼šè¯´ï¼Œå­¦ä¹ è¿™ç§ä¸œè¥¿æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ**å…¶å®ç”¨é€”æœ‰å¾ˆå¤šï¼Œé¦–å…ˆæˆ‘ä»¬ç°åœ¨å‰ç«¯çš„æ„å»ºåŸºæœ¬ä¸Šç¦»ä¸å¼€[Babel](https://babel.dev/)å¯¹`JavaScript`æ–°ç‰¹æ€§çš„æ”¯æŒï¼Œè€Œ`Babel`çš„ä½œç”¨å…¶å®å°±æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨çš„ä½œç”¨ï¼ŒæŠŠæˆ‘ä»¬è¯­è¨€æ–°çš„ç‰¹æ€§è½¬æ¢æˆç›®å‰çš„æµè§ˆå™¨å¯ä»¥æ”¯æŒçš„ä¸€äº›è¯­æ³•ï¼Œè®©æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨æ–°çš„è¯­æ³•ï¼Œä¹Ÿå‡è½»äº†å‰ç«¯å¼€å‘çš„ä¸€äº›è´Ÿæ‹…**ã€‚

å¦ä¸€æ–¹é¢ä½ å¦‚æœçŸ¥é“è¿™äº›åŸç†ï¼Œä½ ä¸ä»…å¯ä»¥å¾ˆå®¹æ˜“çœ‹æ‡‚ä¸€äº›`Babel`çš„è¯­æ³•è½¬æ¢æ’ä»¶çš„æºä»£ç ï¼Œä½ è¿˜å¯ä»¥è‡ªå·±äº²è‡ªåŠ¨æ‰‹å®ç°ä¸€ä¸ªç®€å•çš„è¯­æ³•è½¬æ¢å™¨æˆ–è€…ä¸€äº›æœ‰æ„æ€çš„æ’ä»¶ã€‚è¿™ä¼šè®©ä½ çš„å‰ç«¯èƒ½åŠ›æœ‰ä¸€ä¸ªå¤§çš„æå‡ã€‚

æ—¶é—´è¿‡å¾—å¥½å¿«ï¼Œè·ç¦»ä¸Šæ¬¡å‘å¸ƒæ–‡ç« å·²ç»è¿‡å»ä¸¤ä¸ªæœˆäº†ğŸ˜‚ï¼Œè¿™ç¯‡æ–‡ç« ä¹Ÿæ˜¯è¿‡å®Œå¹´åçš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œå¸Œæœ›ä»¥åè¿˜èƒ½å¤ŸæŒç»­çš„è¾“å‡ºä¸€äº›é«˜è´¨é‡çš„æ–‡ç« ã€‚å½“ç„¶ä¹‹å‰çš„[**è®¾è®¡æ¨¡å¼å¤§å†’é™©ç³»åˆ—**](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMDIzODY5MA==&action=getalbum&album_id=1557269952766771201&scene=173&subscene=0&sessionid=1610180505&enterid=1610180521&from_msgid=2247484071&from_itemidx=1&count=3#wechat_redirect)è¿˜ä¼šæŒç»­æ›´æ–°ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶ç»§ç»­ä¿æŒå…³æ³¨ã€‚

ä»Šå¤©çš„æ–‡ç« åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå¦‚æœä½ å¯¹è¿™ç¯‡æ–‡ç« æœ‰ä»€ä¹ˆæ„è§å’Œå»ºè®®ï¼Œæ¬¢è¿åœ¨æ–‡ç« ä¸‹é¢ç•™è¨€ï¼Œæˆ–è€…åœ¨[è¿™é‡Œ](https://github.com/dreamapplehappy/js-trailing-closure-toy-compiler/issues)æå‡ºæ¥ã€‚ä¹Ÿæ¬¢è¿å¤§å®¶å…³æ³¨æˆ‘çš„å…¬ä¼—å·[**å…³å±±ä¸éš¾è¶Š**](https://image-static.segmentfault.com/426/094/4260948368-54aad325bf3af665_articlex)ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å†™çš„ä¸é”™ï¼Œæˆ–è€…å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œé‚£å°±ç‚¹èµåˆ†äº«ä¸€ä¸‹å§~

å‚è€ƒï¼š
+ [the-super-tiny-compiler](https://github.com/jamiebuilds/the-super-tiny-compiler)
